{% extends 'base.html' %}

{% block title %}
    My Enrollments
{% endblock %}

{% block content %}
<style>
    /* Define specific widths for each column */
    .table th:nth-child(1), .table td:nth-child(1) { width: 5%; }
    .table th:nth-child(2), .table td:nth-child(2) { width: 25%; }
    .table th:nth-child(3), .table td:nth-child(3) { width: 30%; }
    .table th:nth-child(4), .table td:nth-child(4) { width: 20%; }
    .table th:nth-child(5), .table td:nth-child(5) { width: 20%; }

    /* Make the table responsive on small screens */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Mobile view */
    @media (max-width: 768px) {
        .table-responsive {
            max-height: 50vh;
            overflow-y: auto;
        }
        .btn {
            width: 100%; /* Full width for buttons */
        }
        .pagination {
            justify-content: center;
        }
    }

    /* Tablet (769px - 1366px) */
    @media (min-width: 769px) and (max-width: 1366px) {
        .table-responsive {
            max-height: 60vh;
        }
        .btn {
            width: auto; /* Normal button width */
        }
    }

    /* Desktop (1367px - 1920px) */
    @media (min-width: 1367px) and (max-width: 1920px) {
        .table-responsive {
            max-height: 70vh;
        }
    }

    /* Large Desktop (â‰¥1921px) */
    @media (min-width: 1921px) {
        .table-responsive {
            max-height: 80vh;
        }
    }

    /* Adjust pagination for smaller screens */
    .pagination {
        justify-content: center;
    }
</style>

<div class="mt-3">
    <div class='row'>
        <h1>Enrollments</h1>
    </div>
    <!-- Tabs for Personal Enrollments and All Enrollments -->
    <ul class="nav nav-tabs d-flex" id="enrollmentTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="all-enrollments-tab" data-bs-toggle="tab" href="#all-enrollments" role="tab" aria-controls="all-enrollments" aria-selected="true">All Enrollments</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="personal-enrollments-tab" data-bs-toggle="tab" href="#personal-enrollments" role="tab" aria-controls="personal-enrollments" aria-selected="false">My Enrollments</a>
        </li>
        <li class="nav-item ms-auto" id="enroll-button-container">
            <a href="{% url 'group_enrollment:admin_enroll_users' %}" class="btn btn-primary">
                <i class="fas fa-user-plus me-1"></i> Enroll Multiple Users
            </a>
        </li>
    </ul>

    <div class="tab-content mt-3" id="enrollmentTabsContent">
        <!-- All Enrollments Tab -->
        <div class="tab-pane active" id="all-enrollments" role="tabpanel" aria-labelledby="all-enrollments-tab">
            {% if all_enrollments %}
            <div>
                <table class="table table-striped mt-4">
                    <thead>
                        <tr>
                            <th class="text-center">#</th>
                            <th>Student</th>
                            <th>Course Name</th>
                            <th>Date Enrolled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                </table>
                <div class="table-responsive" style="max-height: 53vh;">
                    <table class="table table-striped">
                        <tbody>
                            {% for enrollment in all_enrollments %}
                                <tr>
                                    <td class="text-center">{{ forloop.counter }}</td>
                                    <td>{{ enrollment.student.username }}</td>
                                    <td>{{ enrollment.course.course_name }}</td>
                                    <td>{{ enrollment.date_enrolled|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <a href="{% url 'group_enrollment:edit_enrollment' enrollment.id %}" class="btn btn-outline-primary btn-sm text-center"><i class="fas fa-edit me-1"></i></a>
                                        <form action="{% url 'group_enrollment:delete_enrollment' enrollment.id %}" method="POST" style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-danger btn-sm text-center" onclick="return confirm('Are you sure you want to delete this enrollment?');"><i class="fas fa-trash-alt me-1"></i></button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="pagination d-flex justify-content-center mt-0.5">
                    <nav aria-label="Enrollment pagination">
                        <ul class="pagination">
                            {% if all_enrollments.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1" aria-label="First" onclick="loadPage(1, event); return false;">
                                        <span aria-hidden="true">First</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ all_enrollments.previous_page_number }}" aria-label="Previous" onclick="loadPage({{ all_enrollments.previous_page_number }}, event); return false;">
                                        <span aria-hidden="true">&laquo; Previous</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">First</span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">&laquo; Previous</span>
                                </li>
                            {% endif %}
                
                            <li class="page-item disabled">
                                <span class="page-link">Page {{ all_enrollments.number }} of {{ all_enrollments.paginator.num_pages }}</span>
                            </li>
                
                            {% if all_enrollments.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ all_enrollments.next_page_number }}" aria-label="Next" onclick="loadPage({{ all_enrollments.next_page_number }}, event); return false;">
                                        <span aria-hidden="true">Next &raquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ all_enrollments.paginator.num_pages }}" aria-label="Last" onclick="loadPage({{ all_enrollments.paginator.num_pages }}, event); return false;">
                                        <span aria-hidden="true">Last</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Next &raquo;</span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">Last</span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Personal Enrollments Tab -->
        <div class="tab-pane fade" id="personal-enrollments" role="tabpanel" aria-labelledby="personal-enrollments-tab">
            {% if enrollments %}
            <div class="table-responsive" style="max-height: 53vh;">
                <table class="table table-striped mt-4">
                    <thead>
                        <tr>
                            <th class="text-center">#</th>
                            <th>Course Name</th>
                            <th>Date Enrolled</th>
                        </tr>
                    </thead>
                </table>
                <div class="table-responsive" style="max-height: 53vh;">
                    <table class="table table-striped">
                        <tbody>
                            {% for enrollment in enrollments %}
                                <tr>
                                    <td class="text-center">{{ forloop.counter }}</td>
                                    <td>{{ enrollment.course.course_name }}</td>
                                    <td>{{ enrollment.date_enrolled|date:"Y-m-d H:i" }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
                <div class="alert alert-info">You are not enrolled in any courses.</div>
            {% endif %}
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var enrollButton = document.getElementById('enroll-button-container');
        var allEnrollmentsTab = document.getElementById('all-enrollments-tab');
        var personalEnrollmentsTab = document.getElementById('personal-enrollments-tab');
    
        // Show button only when All Enrollments tab is active
        function toggleEnrollButton() {
            if (enrollButton && allEnrollmentsTab) {
                enrollButton.style.display = allEnrollmentsTab.classList.contains('active') ? 'block' : 'none';
            }
        }
    
        // Attach event listeners to tab switches, if tabs exist
        if (allEnrollmentsTab && personalEnrollmentsTab) {
            allEnrollmentsTab.addEventListener('shown.bs.tab', toggleEnrollButton);
            personalEnrollmentsTab.addEventListener('shown.bs.tab', toggleEnrollButton);
        }
    
        // Function to load the page based on screen width (JavaScript only)
        function loadPage(pageNumber = 1, event = null) {
            if (event) event.preventDefault();
            
            var itemsPerPage = getItemsPerPage();
            var screenWidth = window.innerWidth; // Get screen width
    
            $.ajax({
                url: window.location.href,
                data: { page: pageNumber, items_per_page: itemsPerPage },
                type: 'GET',
                success: function(data) {
                    $('#enrollmentTabsContent').html($(data).find('#enrollmentTabsContent').html());
                    $('.pagination').html($(data).find('.pagination').html());
                },
                error: function(xhr, status, error) {
                    console.error('Error loading page:', error);
                }
            });
        }
    
        // Function to get the number of items per page based on screen size
        function getItemsPerPage() {
            var screenWidth = window.innerWidth;
    
            if (screenWidth <= 768) {  // Mobile
                return 5;
            } else if (screenWidth <= 1366) {  // Tablet or small laptop
                return 10;
            } else if (screenWidth <= 1920) {  // Large laptop or desktop
                return 15;
            } else {  // Very large desktop
                return 20;
            }
        }
    
        // Initial page load based on current URL and screen width
        var currentPage = new URL(window.location.href).searchParams.get('page') || 1;
        loadPage(currentPage);
    
        // Resize listener
        window.addEventListener('resize', function() {
            loadPage(currentPage);  // Reload with updated screen width
        });
    
        // Call function initially to set the correct button visibility
        toggleEnrollButton();
    });
    
</script>
{% endblock %}